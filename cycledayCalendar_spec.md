# 魔琉血悶怒曜尾 ― 環状月暦 仕様書

> **要約**：
> 「1984-01-01」を基準に 2/3/5/7 日周期の“曜日”を計算し、SVG の円環レイアウトで 1 か月分の日付と複数周期ラベルを同時に表示するブラウザ向けカレンダー。現在日は扇形ポインタとハイライトで指し示し、リアルタイムの日時表示とスクリーンリーダー用の代替リストを備える。

---

## 1. 目的・背景

* 7 日週に加えて 2 日・3 日・5 日周期のリズムを同時に把握できるようにする。
* 月を円環で描くことで周期性を直感的に理解できるビジュアルを提供する。
* 今日の位置と周期を即座に把握でき、ハッシュフラグメントで共有できる静的 Web アプリとして構成する。

---

## 2. 表示要件

### 2.1 ヘッダ

1. タイトル「魔琉血悶怒曜尾 ― 環状月暦」。
2. 現在日時を 1 秒ごとに更新。形式は `YYYY-MM-DD(複周期ラベル連結) HH:MM:SS`。
   * 例: `2024-03-14(日石風木) 21:09:26`
   * `aria-live="polite"`/`aria-atomic="true"` によってスクリーンリーダーへ通知。
3. 月移動ナビゲーション: 「◀ 前月」「今日へ」「次月 ▶」。

### 2.2 環状月暦 (SVG)

* SVG ビュー全体に 1 か月分の日付を均等角度で配置する。
* 各日付:
  * 中央に DOM を表示。
  * 2/3/5/7 日周期ラベルを同心円状に配置し、色で区別する。
  * 選択中の日付は外周のリングで強調する。
  * 今日であれば背景円と太字で強調する。
* 今日の位置には外周に向けて扇形ポインタ（三角形）を描画し、現在日の角度を示す。
* SVG 背景には周期ごとの淡色バンドを敷き、視覚的なガイドとする。

### 2.3 ナビゲーション操作

* 前月・次月ボタンで月を移動する。
* 「今日へ」で現在の年月に戻り、当日を選択状態にする。
* 月移動に合わせて `location.hash` を `#YYYY-MM` 形式で更新し、再読み込みや共有に対応する。

### 2.4 凡例パネル

* 右側に凡例パネルを配置し、各周期の色とラベルを表示する。
* 「凡例を隠す」ボタンでパネルを畳み、`aria-expanded` を更新。畳んだ状態では `aria-hidden` と `inert` を付与し、視覚的にも余白を詰める。
* 小画面では凡例を上部に移動し、レイアウトが 1 カラムになる。

### 2.5 アクセシビリティ補助

* SVG の下に日別の周期ラベル一覧 (`YYYY年MM月 日別サイクル`) を DOM に出力し、スクリーンリーダーが線形で読み取れるようにする。
* 各日付グループには `role="button"` と `tabindex="0"` を与え、Enter/Space で選択できる。

---

## 3. 周期ラベルと命名

* 2 日周期: **陰 / 陽**
* 3 日周期: **石 / 鋏 / 紙**
* 5 日周期: **風 / 雨 / 雷 / 雲 / 霧**
* 7 日周期: **日 / 月 / 火 / 水 / 木 / 金 / 土**（基準日からの暦日差に基づく）

今日の日時表示では上記ラベルを連結して `(日石風木)` のように表記する。

---

## 4. 計算仕様

### 4.1 基準日と日差

* 基準日: `1984-01-01` ローカルタイム。
* 日付オブジェクトは常に 00:00 (ローカル) に正規化して差分を取る。

```js
const baseDate = new Date(1984, 0, 1);
const deltaDays = (date) => {
  const midnight = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  return Math.floor((midnight - baseDate) / 86_400_000);
};
```

### 4.2 周期インデックス

```js
const mod = (delta, n) => ((delta % n) + n) % n;
```

* いずれの周期も基準日からの暦日差を使ってインデックスを算出し、対応するラベルを取得する。

---

## 5. 描画仕様

### 5.1 ビューポートと半径

* SVG `viewBox` は `0 0 600 600`。
* 中心: `(300, 300)`。
* 基本半径 `R_date = 240`、内側へ 38px ずつ縮めてサブリングを配置。
* 画面幅・高さに応じて SVG コンテナのサイズを JavaScript で可変調整する。

### 5.2 座標計算

```js
const theta = (2 * Math.PI * ((day - 0.5) / daysInMonth)) - Math.PI / 2;
const x = center + R * Math.cos(theta);
const y = center + R * Math.sin(theta);
```

* 文字要素は水平方向のまま配置し、読みやすさを優先する。

### 5.3 今日ポインタ

* 今日の扇形ポインタは 4 点の多角形で描画する。
* 角度幅は 1 日の中心角の約 95% とし、外半径は日付リングよりさらに外側 (約 +56px)。
* `pointer-group` にまとめておき、他の要素と重ならないよう `pointer-events: none` を指定。

---

## 6. 状態管理とインタラクション

* `state` で `today`/`viewYear`/`viewMonth`/`selectedDate` を管理する。
* `DOMContentLoaded` 時に現在日の状態とハッシュ (`#YYYY-MM`) を初期化し、`hashchange` で外部操作にも追従する。
* 日付をクリックまたはキーボード操作すると `selectedDate` が更新され、再描画時に選択リングを表示する。
* ウィンドウリサイズと凡例の表示切り替え時に再描画してレイアウトを調整する。

---

## 7. ファイル構成

```
.
├── index.html        # アプリ本体 (GitHub Pages ルート)
├── 404.html          # GitHub Pages 用フォールバック (index の複製)
├── css/
│   └── styles.css    # レイアウトとテーマ
├── js/
│   └── app.js        # 状態管理・描画ロジック
├── README.md
└── cycledayCalendar_spec.md
```

---

## 8. 技術メモ

* 依存ライブラリはなく、HTML/CSS/Vanilla JS のみで構成する静的サイト。
* カラーテーマは CSS 変数と `color-scheme: light dark;` で環境のダークモードに追従可能。
* SVG テキストはタブラー数字 (`font-variant-numeric: tabular-nums`) を利用し、時間や日付の桁ズレを防止する。
* スクリーンリーダーでの把握しやすさのため、SVG には `role="img"` とテキスト代替 (`ring-title`/`ring-desc`) を提供する。
