# 魔琉血悶怒曜尾 ― 環状月暦（Ring Month Calendar） 仕様書

> **要約**：
> 「1980-01-01」を基準に、**2/3/5/7 日周期**の“曜日”を**月間の円環レイアウト**で表示するデジタル・カレンダー。各日付は円周上に等間隔配置し、\*\*現在日付は“時計の針”\*\*で指し示す。現在日時の数値表示も併記する。

* **正式名称（提案）**：干支多周曜 ― 環状月暦

  * 略称：**環曜（かんよう）** / 英名：**Eto Multi-Cycle Ring Calendar**
  * 代替：**申支曜日カレンダー**（副題として表記可）

---

## 1. 目的・背景

* 7 日週に加え、「**2/3/5 日周期**の“曜日”」を**個人利用のサブカレンダー**として参照できるようにする。
* \*\*円環（リング）\*\*で月を表示することで、**周期＝環**という直感を強化する。
* 日付と多重“曜日”が**一目で俯瞰**でき、今日の位置は\*\*“針”\*\*により瞬時に認識できる。

---

## 2. 表示要件

### 2.1 必須表示

1. **現在日時**（ローカルタイムゾーン）

   * 形式例：`2025-09-22 (Mon) 20:21:05`
   * 1 秒更新。`aria-live="polite"`。
2. **環状月暦（SVG）**

   * **円周上に当月の全日付**（1..D）を等角度で配置。
   * 各日付の**内側に 2/3/5/7 日周期の“曜日”ラベル**を小型で併記。
   * **当日**は強調（太字・背景円）。
   * \*\*“針”\*\*で当日の角度位置を指す（時計の分針に相当。先端は円周の少し外側まで）。
3. **ナビゲーション**

   * 前月 / 次月 ボタン。
   * 今日へ戻る。

### 2.2 任意表示（MVPに含める）

* 右（もしくは下部）に\*\*“今日の詳細”\*\*パネル：

  * `[二]子曜 / [三]辰曜 / [五]庚曜 / [七]月曜` のように大きく表示。
  * 基準日と計算式のヘルプ（ツールチップ）。

---

## 3. 命名規則（曜日名）

* **2日周期**：**子曜 / 午曜**
* **3日周期**：**子曜 / 辰曜 / 申曜**
* **5日周期**：**甲曜 / 丙曜 / 戊曜 / 庚曜 / 壬曜**
* **7日周期**：**日/月/火/水/木/金/土**（UI 表示では「○曜」）

> UI 上の識別性を高めるため、**系統接頭辞**を併記：
> `[二]子曜`, `[三]辰曜`, `[五]庚曜`, `[七]月曜`。
> 凡例で色と接頭辞の対応を示す。

---

## 4. 計算仕様

### 4.1 基準日と日差

* **基準日**：`1980-01-01`（ローカル 00:00）
* **対象日**：各セルの日付（ローカル 00:00）
* **暦日差**：

  ```
  base = new Date(1980, 0, 1, 0, 0, 0, 0)  // ローカル
  d    = new Date(Y, M, DOM, 0, 0, 0, 0)   // ローカル
  Δdays = floor( (d - base) / 86_400_000 )
  ```

  * 1980年以前も負値で成立。
  * “暦日差”で扱うことでタイムゾーンの 1 日境界に順応。

### 4.2 周期インデックス

```
idxN = ((Δdays % N) + N) % N   // N ∈ {2,3,5,7}
```

### 4.3 インデックス→名称

* 2日：`[ '子', '午' ]`
* 3日：`[ '子', '辰', '申' ]`
* 5日：`[ '甲', '丙', '戊', '庚', '壬' ]`
* 7日（JS `getDay()` 準拠）：`[ '日', '月', '火', '水', '木', '金', '土' ]`

---

## 5. 円環レイアウト（SVG 幾何）

### 5.1 座標系

* SVG ビュー：`viewBox="0 0 W H"`
* 中心：`(cx, cy) = (W/2, H/2)`
* 半径：

  * `R_date`（日付リング）
  * `R_2`, `R_3`, `R_5`, `R_7`（内向きのサブリング）
  * 例：`R_date = min(W,H) * 0.42`、各サブリングは `R_date - k * step`（`step`=24px など）

### 5.2 角度配置

* **当月日数**：`D`（28–31）
* **角度（上＝12時方向起点、時計回り）**：

  ```
  θ_i = 2π * ( (i - 0.5) / D ) - π/2    // i = 1..D
  ```
* **座標**：

  ```
  x = cx + R * cos(θ_i)
  y = cy + R * sin(θ_i)
  ```

### 5.3 タイポグラフィ

* **日付**：外周寄りに小型ラベル（例：12–14px）。
* **各系ラベル**：放射状（外向き）ではなく**接線回転**は避け、**水平**固定で可読性を優先。
* **衝突回避**：

  * 小画面では「2/3/5 系」を**記号モード**（例：二=●, 三=▲, 五=■, 七=◆ + 文字）に自動縮約。
  * あるいはホバー/タップで拡張ポップアップにフル名。

### 5.4 現在日“針”

* **角度**：`θ_today` は当月の `i = 今日の DOM` を用いた `θ_i` と同じ。
* **針**：中心 `(cx,cy)` から `R_hand_end = R_date + handOvershoot`（例：+12px）までの直線。
* 線幅 2–3px、終端に円キャップ。**アニメーション**でオーバーシュート → 静止（好み）。

---

## 6. UI/UX

* **ヘッダ**：タイトル、現在日時（秒更新）。
* **リング本体**：

  * 中央に\*\*“今日の詳細”\*\*（大きめに `[二]子 / [三]辰 / [五]庚 / [七]月`）。
  * 円周外側に**凡例**（色＋接頭辞）。
* **フッタ**：基準日・ライセンス・GitHub リンク。

### 6.1 配色（推奨）

* `[二]` 青、`[三]` 緑、`[五]` 橙、`[七]` 紫。
* ただし**色に依存しない**識別（接頭辞・記号）を併用。

### 6.2 アクセシビリティ

* コントラスト AA。
* キーボード操作（左右で月移動）。
* スクリーンリーダー向けに**線形リストの代替表**を下部に併記（例：`9/22 → [二]子, [三]辰, [五]庚, [七]月`）。

---

## 7. 技術仕様

### 7.1 スタック

* **静的**：HTML + CSS + Vanilla JS + SVG（依存ゼロ）。
* **タイムゾーン**：ブラウザローカル。
* **国際化**：文字列テーブル化（初期日本語）。

### 7.2 ファイル構成

```
/ (repo root)
├─ index.html
├─ js/
│  └─ app.js
├─ css/
│  └─ styles.css
├─ assets/
│  └─ icon.svg
├─ README.md
├─ LICENSE  (MIT)
└─ 404.html  ← index.html の複製
```

### 7.3 主要 API（擬似コード）

```js
// 定数
const NAMES_2 = ['子','午'];
const NAMES_3 = ['子','辰','申'];
const NAMES_5 = ['甲','丙','戊','庚','壬'];
const NAMES_7 = ['日','月','火','水','木','金','土'];
const PREFIX = {2:'[二]',3:'[三]',5:'[五]',7:'[七]'};

// 日差
const baseMidnight = () => new Date(1980,0,1,0,0,0,0);
const dayMidnight  = (y,m,dom) => new Date(y,m,dom,0,0,0,0);
const dayDiff = (y,m,dom) => Math.floor((dayMidnight(y,m,dom)-baseMidnight())/86400000);
const mod = (n,m) => ((n % m) + m) % m;

// ラベル
function labelsFor(y,m,dom){
  const d = dayDiff(y,m,dom);
  return {
    2: `${PREFIX[2]}${NAMES_2[mod(d,2)]}曜`,
    3: `${PREFIX[3]}${NAMES_3[mod(d,3)]}曜`,
    5: `${PREFIX[5]}${NAMES_5[mod(d,5)]}曜`,
    7: `${PREFIX[7]}${NAMES_7[new Date(y,m,dom).getDay()]}曜`,
  };
}

// 角度（上=12時, 時計回り）
const angleFor = (dom, daysInMonth) => 2*Math.PI*((dom-0.5)/daysInMonth) - Math.PI/2;

// SVG レンダ（概略）
function renderRing(y,m){
  const D = new Date(y,m+1,0).getDate();
  // 1..D を map して <text> とサブラベル群を配置、today には背景円、
  // 針は angleFor(today, D) で <line> を更新。
}
```

---

## 8. デザイン仕様（CSS 抜粋）

* ベース：システム UI フォント。
* 文字：日付 12–14px、サブラベル 10–12px。
* ハイライト：今日セルは淡色円の上に黒文字。
* レスポンシブ：`max(320px, 90vw)` の正方ビュー。小画面でサブラベルを縮約表示。

---

## 9. 機能要件詳細

1. **月移動**：

   * `prev` で `(y,m-1)`、`next` で `(y,m+1)`。境界は年跨ぎ。
   * 移動後、**針は“その月における今日の DOM が存在する場合のみ表示”**。存在しない（例：今日=31日、表示月=30日）ときは**最も近い日**を点線針で示すか、針非表示。MVPでは非表示でよい。
2. **クリック/ホバー**：

   * 日付をクリックで中央の“詳細”をその日に切替（`選択日`）。
   * “今日へ”で選択解除→今日に戻る。
3. **Deep Link**：

   * URL ハッシュに `#YYYY-MM` を反映（任意）。
   * リロードで同月を復元。

---

## 10. テスト計画

* **基準整合**

  * 1980-01-01 の Δdays=0 → 2=子, 3=子, 5=甲。
* **月差角度**

  * 角度 `θ_i` が `i` に比例して単調増加。`i=1` が正上、`i=D` がほぼ 360° 手前。
* **うるう年**

  * 2 月（28/29）の D に応じて再配置。
* **負日差**

  * 1979-12 表示でも 2/3/5 系が破綻しない（mod 正規化）。
* **アクセシビリティ**

  * スクリーンリーダーで代替リストに全日が読み上げ可能。
* **パフォーマンス**

  * 60fps 近傍でパン/更新。ノード再生成最小化。

---

## 11. デプロイ（GitHub Pages）

1. リポジトリ作成（Public）。
2. 本仕様に沿って `index.html`, `js/app.js`, `css/styles.css`, `404.html` を追加。
3. `Settings → Pages → Deploy from a branch`、`main` / root を選択。
4. 公開 URL：`https://<username>.github.io/<repo>/`。
5. 404 対策として `404.html` を `index.html` の複製にしておく。

---

## 12. ライセンス

* **MIT License**。
* README に「干支文字は Unicode 収録の通り、特別なフォント依存は避ける」旨を記載。

---

## 13. 将来拡張

* **ズーム**（リング幅の拡張）、**印刷用（A4 円環）**、**PWA**、**ICS/CSV エクスポート**（`N` 日周期のタスクテンプレ）。
* **ラベル切替**（A/B、記号、色弱配慮テーマ）、**週頭（Sun/Mon）切替**。
* **祝日レイヤ**（ローカル JSON）。

---

## 付録 A：HTML スケルトン（参考）

```html
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>干支多周曜 ― 環状月暦</title>
<link rel="stylesheet" href="css/styles.css"/>
</head>
<body>
<header>
  <h1>干支多周曜 ― 環状月暦</h1>
  <div id="now" aria-live="polite"></div>
  <nav><button id="prev">←</button><button id="today">今日</button><button id="next">→</button></nav>
</header>
<main>
  <section id="ring"></section>
  <aside id="detail"></aside>
</main>
<footer>
  <small>基準日: 1980-01-01 / MIT License</small>
</footer>
<script src="js/app.js"></script>
</body>
</html>
```

---

## 付録 B：ラベル衝突縮約の方針

* ビューポート幅が閾値以下（例：`< 420px`）では、

  * サブラベルを **`[二]子 / [三]辰 / [五]庚 / [七]月` → `二:子 三:辰 五:庚 七:月`** へ短縮。
  * さらに小さい場合は **`二:子 三:辰 五:庚 七:月` → `子 辰 庚 月`**（凡例色＋接頭辞で判別）。

